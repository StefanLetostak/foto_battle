<!DOCTYPE html>
<html lang="sk">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Foto Battle</title>
		<link rel="stylesheet" href="styles.css" />
</head>
<body>
	<!-- Dekor√°cie: boƒçn√© z√°vesy -->
	<img class="curtain curtain-left" src="./doplnky/lavy_zaves.png" alt="" aria-hidden="true" />
	<img class="curtain curtain-right" src="./doplnky/pravy_zaves.png" alt="" aria-hidden="true" />

	<main>
		<div id="grid" aria-label="Hracia mrie≈æka 30 pol√≠"></div>
		<section id="teachers">
			<div class="teacher active" data-index="0">
				<div class="teacher-header">
					<span class="teacher-name" aria-label="Meno uƒçiteƒæa 1">SE≈§KA</span>
				</div>
				<div class="score" data-score>0</div>
				<!-- Ovl√°danie sk√≥re je dostupn√© cez kl√°vesy 1/2/3/4 -->
			</div>
			<!-- Extra pole #31 medzi uƒçiteƒæmi -->
			<div id="extraCellSlot" aria-label="Pole 31"></div>
			<div class="teacher" data-index="1">
				<div class="teacher-header">
					<span class="teacher-name" aria-label="Meno uƒçiteƒæa 2">GABKA</span>
				</div>
				<div class="score" data-score>0</div>
				<!-- Ovl√°danie sk√≥re je dostupn√© cez kl√°vesy 1/2/3/4 -->
			</div>
		</section>
				<div id="liveRegion" aria-live="polite" style="position:absolute; left:-9999px; top:-9999px;">Ready</div>
	</main>
	<div id="modal" role="dialog" aria-modal="true" aria-labelledby="studentName">
		<div id="modalContent">
			<div id="difficultyBadge" class="difficulty-badge" aria-hidden="true"></div>
			<div id="studentName" class="hiddenName"></div>
			<img id="studentPhoto" alt="Foto ≈æiaka" />
		</div>
	</div>
	<!-- Fullscreen score overlay for add/subtract animations -->
	<div id="scoreOverlay" aria-hidden="true"><div class="overlay-text"></div></div>
	<!-- Victory overlay with confetti -->
	<div id="victoryOverlay" aria-hidden="true">
		<canvas id="confettiCanvas"></canvas>
		<div class="victory-content">
			<div class="victory-title">V√ç≈§AZ</div>
			<div class="victory-name"></div>
			<div class="victory-subtitle">üèÜ</div>
		</div>
	</div>
		<button id="fullscreenFloatBtn" aria-label="Fullscreen" title="Fullscreen" style="position:fixed; right:.6rem; bottom:.6rem; z-index:1500; background:rgba(67,183,73,0.15); color:#fff; padding:.5rem .7rem; font-size:.7rem; border-radius:.5rem; backdrop-filter:blur(4px); box-shadow:0 2px 6px rgba(0,0,0,.3); opacity:.35; transition:.25s;">
			‚õ∂
		</button>
	<script>
	(function(){
		// In-memory state
		const state = {
			students: [], // {name:string, number:number, url:string, difficulty:1|2|3}
			cells: Array.from({length:31}, (_,i)=>({ number:i+1, used:false, student:null })),
			activeTeacher:0,
			teachers:[{name:'SE≈§KA', score:0},{name:'GABKA', score:0}],
			currentCell:null,
			modalStep:0 // 0: pred fotkou (uk√°≈æ obtia≈ænos≈•); 1: uk√°≈æ fotku; 2: uk√°≈æ meno; potom zavri
		};

		const gridEl = document.getElementById('grid');
		const modalEl = document.getElementById('modal');
		const studentNameEl = document.getElementById('studentName');
		const studentPhotoEl = document.getElementById('studentPhoto');
		const difficultyBadgeEl = document.getElementById('difficultyBadge');
	const teacherContainer = document.getElementById('teachers');
	const scoreOverlay = document.getElementById('scoreOverlay');

		// Build single cell element (reusable for grid and extra slot)
		function buildCellElement(cell){
			const d = document.createElement('div');
			let diffClass = '';
			if(cell.student && typeof cell.student.difficulty === 'number'){
				const lvl = Math.max(1, Math.min(3, cell.student.difficulty|0));
				diffClass = ' diff-'+lvl;
			}
			d.className='cell'+(cell.used?' used':'')+diffClass;
			d.innerHTML = '<span class="num">'+cell.number+'</span>';
			d.tabIndex= cell.used ? -1 : 0;
			d.setAttribute('data-number', cell.number);
			if(!cell.used){
				d.addEventListener('click', ()=>openCell(cell));
				d.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openCell(cell); } });
			}
			return d;
		}

		// Build grid (first 30 cells)
		function renderGrid(){
			gridEl.innerHTML='';
			state.cells.slice(0,30).forEach(cell=>{
				gridEl.appendChild(buildCellElement(cell));
			});
			// Also render extra cell #31 in its slot
			renderExtraCell();
		}

		function renderExtraCell(){
			const slot = document.getElementById('extraCellSlot');
			if(!slot) return;
			slot.innerHTML = '';
			const cell31 = state.cells[30]; // index 30 => number 31
			if(cell31){
				slot.appendChild(buildCellElement(cell31));
			}
		}

			let lastFocusedElement = null;
			function openCell(cell){
				if(cell.used) return;
				lastFocusedElement = document.querySelector('.cell[data-number="'+cell.number+'"]');
				state.currentCell = cell;
				state.modalStep = 0;
				updateModalContent();
				showModal();
			}

		function showModal(){
			modalEl.classList.add('visible');
			modalEl.focus();
			document.body.classList.add('curtains-hidden');
		}
			function hideModal(){
				modalEl.classList.remove('visible');
				document.body.classList.remove('curtains-hidden');
				state.currentCell = null;
				if(lastFocusedElement && !lastFocusedElement.classList.contains('used')){
					lastFocusedElement.focus();
				}
				lastFocusedElement = null;
			}

		function cycleModal(){
			if(!state.currentCell) return;
			if(state.modalStep === 0){
				// Show photo
				state.modalStep = 1;
			} else if(state.modalStep === 1){
				// Show name
				state.modalStep = 2;
			} else {
				// Close & mark used, rotate teacher
				state.currentCell.used = true;
				if(state.currentCell.student){ /* could update stats */ }
				hideModal();
				renderGrid();
				rotateTeacher();
				return;
			}
			updateModalContent();
		}

		function updateModalContent(){
			const cell = state.currentCell;
			if(!cell){ return; }
			const student = cell.student;
			if(state.modalStep === 0){
				// initial: hide photo, hide name
				studentPhotoEl.style.display='none';
				// Clear previous photo reference to prevent showing stale image later
				studentPhotoEl.removeAttribute('src');
				studentPhotoEl.alt = 'Foto ≈æiaka';
				studentNameEl.textContent = student? student.name : '';
				studentNameEl.classList.add('hiddenName');
				studentNameEl.style.display='none';
				// show difficulty badge before photo
				const diff = student && typeof student.difficulty === 'number' ? student.difficulty : 1;
				const bodLabel = diff === 1 ? ' bod' : ' body';
				difficultyBadgeEl.textContent = diff + bodLabel;
				difficultyBadgeEl.setAttribute('data-level', String(diff));
				difficultyBadgeEl.style.display = 'flex';
				modalEl.classList.remove('photo-full');
			} else if(state.modalStep === 1){
				// show photo only
				if(student && student.url){
					studentPhotoEl.src = student.url;
					studentPhotoEl.alt = 'Foto ≈æiaka'; // nezobrazuj meno v alt pred odhalen√≠m
					studentPhotoEl.style.display='block';
				} else {
					// No valid photo: keep hidden (or could show placeholder)
					studentPhotoEl.style.display='none';
					studentPhotoEl.removeAttribute('src');
				}
				studentNameEl.classList.add('hiddenName');
				studentNameEl.style.display='none'; // √∫plne skry≈• v kroku fotky
				difficultyBadgeEl.style.display = 'none';
				// Activate fullscreen photo layout only if we have a valid photo
				if(student && student.url){
					modalEl.classList.add('photo-full');
				} else {
					modalEl.classList.remove('photo-full');
				}
			} else if(state.modalStep === 2){
				// overlay name over fullscreen photo
				if(student && student.url){
					modalEl.classList.add('photo-full');
					studentPhotoEl.style.display='block';
					studentPhotoEl.alt = 'Foto: '+student.name;
				} else {
					studentPhotoEl.style.display='none';
					modalEl.classList.remove('photo-full');
				}
				studentNameEl.textContent = student? student.name : '';
				studentNameEl.classList.remove('hiddenName');
				studentNameEl.style.display='block';
				studentNameEl.classList.add('overlay-name');
				difficultyBadgeEl.style.display = 'none';
			}
		}

		modalEl.addEventListener('click', (e)=>{
			if(e.target===modalEl) { cycleModal(); }
		});
		document.getElementById('modalContent').addEventListener('click', (e)=>{
			// Cycle when clicking content area
			cycleModal();
		});
		document.addEventListener('keydown', e=>{
			if(e.key==='Escape' && modalEl.classList.contains('visible')){ hideModal(); }
		});

	// Queue for score animations to prevent interruption
	const scoreAnimationQueue = [];
	let isAnimatingScore = false;

	// Scoring helpers + keyboard shortcuts (1/2 add; 3/4 subtract)
	function adjustScore(teacherIdx, delta){
		if(teacherIdx < 0 || teacherIdx >= state.teachers.length) return;
		state.teachers[teacherIdx].score += delta;
		renderTeachers();
		announceScore(teacherIdx);
		// Add to queue instead of showing immediately
		scoreAnimationQueue.push({ teacherIdx, delta, score: state.teachers[teacherIdx].score });
		processScoreAnimationQueue();
	}

	function processScoreAnimationQueue(){
		if(isAnimatingScore || scoreAnimationQueue.length === 0) return;
		
		isAnimatingScore = true;
		const { teacherIdx, delta, score } = scoreAnimationQueue.shift();
		
		// Show animation
		showScoreOverlay(score, delta);
		
		// Wait for animation to complete before processing next
		setTimeout(()=>{
			scoreOverlay.classList.remove('show');
			isAnimatingScore = false;
			processScoreAnimationQueue();
		}, 1200);
	}
		// Global keyboard handling: ignore when typing into inputs
		document.addEventListener('keydown', (e)=>{
			const ae = document.activeElement;
			if(ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) return;
			if(e.ctrlKey || e.metaKey || e.altKey) return;
			const k = (e.key || '').toLowerCase();
			// Space bar to switch active teacher
			if(e.key === ' ' && !modalEl.classList.contains('visible')){
				e.preventDefault();
				rotateTeacher();
				return;
			}
			switch(k){
				case '1':
				case 'a': adjustScore(0, +1); break;
				case '2':
				case 's': adjustScore(1, +1); break;
				case '3':
				case 'd': adjustScore(0, -1); break;
				case '4':
				case 'f': adjustScore(1, -1); break;
				case 'k': showVictory('Svetlana'); break;
				case 'l': showVictory('Gabriela'); break;
				default: break;
			}
		});

		// Teacher handling
		function renderTeachers(){
			const teacherEls = document.querySelectorAll('.teacher');
			teacherEls.forEach((el,i)=>{
				el.classList.toggle('active', i===state.activeTeacher);
				// Remove any existing turn badge and do not display it
				const badge = el.querySelector('.turnBadge');
				if(badge) badge.remove();
				// Score display
				el.querySelector('[data-score]').textContent = state.teachers[i].score;
				// Name display
				const nameEl = el.querySelector('.teacher-name');
				if(nameEl && nameEl.textContent !== state.teachers[i].name){ nameEl.textContent = state.teachers[i].name; }
			});
		}
		function rotateTeacher(){
				if(modalEl.classList.contains('visible')) return; // do not rotate mid-question
				state.activeTeacher = (state.activeTeacher+1)%state.teachers.length;
				renderTeachers();
				announceTurn();
		}
		// Klik na blok uƒçiteƒæa zmen√≠ akt√≠vneho (ak modal nie je otvoren√Ω)
		teacherContainer.addEventListener('click', (e)=>{
			const t = e.target.closest('.teacher');
			if(!t || modalEl.classList.contains('visible')) return;
			const idx = parseInt(t.getAttribute('data-index'),10);
			if(!isNaN(idx) && idx !== state.activeTeacher){
				state.activeTeacher = idx;
				renderTeachers();
				announceTurn();
			}
		});
		// Polia pre vlastn√© men√° uƒçiteƒæov boli odstr√°nen√©; pou≈æ√≠va sa predvolen√© nastavenie.
		// Old score buttons removed and replaced by keyboard-aware buttons above

		// File handling
			// Auto-pokus naƒç√≠ta≈• JSON d√°tov√Ω s√∫bor pri ≈°tarte (ticho zlyh√°)

				async function loadStudentsFromJson(){
					try {
						const res = await fetch('./data/students.json', {cache:'no-store'});
						if(!res.ok){
							if(res.status === 404){ console.info('students.json nen√°jden√Ω ‚Äì pokraƒçujem bez d√°t'); return; }
							throw new Error('HTTP '+res.status);
						}
					const list = await res.json();
					if(!Array.isArray(list)) throw new Error('JSON mus√≠ by≈• pole objektov');
					state.students = list.map(item=>({
						name: item.name||'',
						number: item.number,
						// Ak je photo nepr√°zdny re≈•azec, ber ho (http/https, relative, data URI), inak pr√°zdny
						url: (typeof item.photo === 'string' && item.photo.trim()!=='') ? item.photo.trim() : '',
						difficulty: (typeof item.difficulty === 'number' && item.difficulty >=1 && item.difficulty <=3) ? item.difficulty : (Math.floor(Math.random()*3)+1)
					}));
					mapStudentsToCells();
					announceLoad(list.length);
					// Preload all photos immediately after loading JSON
					preloadPhotos();
				} catch(err){
						console.warn('Chyba naƒç√≠tania JSON:', err.message);
				}
			}

			// Preload all student photos to avoid loading delays when clicking cells
			async function preloadPhotos(){
				const photoUrls = state.students
					.map(s => s.url)
					.filter(url => url && url.trim() !== '');
				
				if(photoUrls.length === 0) return;
				
				showTemporaryMessage(`Naƒç√≠tavam ${photoUrls.length} fotiek...`, 'info');
				
				let loaded = 0;
				const promises = photoUrls.map(url => {
					return new Promise((resolve) => {
						const img = new Image();
						img.onload = () => {
							loaded++;
							console.log(`Loaded ${loaded}/${photoUrls.length}: ${url}`);
							resolve();
						};
						img.onerror = () => {
							loaded++;
							console.warn(`Failed to load: ${url}`);
							resolve(); // Continue even if one fails
						};
						img.src = url;
					});
				});
				
				await Promise.all(promises);
				showTemporaryMessage(`‚úì V≈°etky fotky naƒç√≠tan√© (${loaded})`, 'info');
				console.log('All photos preloaded successfully');
			}

		function mapStudentsToCells(){
			// Assign students to cells by student.number if defined else next free
			// Clear existing assignments first
			state.cells.forEach(c=> c.student = null);
			const unspecified = [];
			state.students.forEach(st=>{
						if(st.number && st.number>=1 && st.number<=state.cells.length){
							const cell = state.cells[st.number-1];
					if(!cell.student) cell.student = st; else unspecified.push(st);
				} else {
					unspecified.push(st);
				}
			});
			// Fill remaining cells sequentially
			state.cells.forEach(cell=>{
				if(!cell.student && unspecified.length){ cell.student = unspecified.shift(); }
			});
			// Update used class remains
			renderGrid();
		}

			function showTemporaryMessage(text, type){
				let box = document.getElementById('flashBox');
				if(!box){
					box = document.createElement('div');
					box.id='flashBox';
					box.style.position='fixed';
					box.style.top='1rem';
					box.style.left='50%';
					box.style.transform='translateX(-50%)';
					box.style.padding='0.75rem 1.2rem';
					box.style.borderRadius='0.75rem';
					box.style.fontWeight='600';
					box.style.zIndex='2000';
					box.style.backdropFilter='blur(6px)';
					box.style.boxShadow='0 6px 18px rgba(0,0,0,.4)';
					document.body.appendChild(box);
				}
				box.textContent = text;
				box.style.background = type==='error' ? 'linear-gradient(135deg,#eb3349,#f45c43)' : 'linear-gradient(135deg,#43b749,#6edc73)';
				box.style.color = '#fff';
				box.style.opacity='1';
				setTimeout(()=>{ box.style.transition='opacity .5s'; box.style.opacity='0'; }, 2500);
			}
			function announceLoad(count){
				const live = document.getElementById('liveRegion');
				live.textContent = 'Naƒç√≠tan√Ωch ≈°tudentov: '+count;
				showTemporaryMessage('Naƒç√≠tan√Ωch '+count+' ≈°tudentov', 'info');
			}

				function announceScore(idx){
					const live = document.getElementById('liveRegion');
					live.textContent = state.teachers[idx].name + ' sk√≥re: ' + state.teachers[idx].score;
				}
				function announceTurn(){
					const live = document.getElementById('liveRegion');
					live.textContent = 'Na rade: ' + state.teachers[state.activeTeacher].name;
				}

		function showScoreOverlay(currentScore, delta){
			if(!scoreOverlay) return;
			const textEl = scoreOverlay.querySelector('.overlay-text');
			if(!textEl) return;
			// Show the score passed from queue
			textEl.textContent = String(currentScore);
			scoreOverlay.classList.remove('show','add','sub');
			scoreOverlay.classList.add(delta >= 0 ? 'add' : 'sub');
			// restart animation
			void scoreOverlay.offsetWidth;
			scoreOverlay.classList.add('show');
			// Note: hiding is now handled by queue processor
		}

		// Victory animation with confetti
		function showVictory(winnerName){
			const victoryOverlay = document.getElementById('victoryOverlay');
			const victoryNameEl = victoryOverlay.querySelector('.victory-name');
			if(!victoryOverlay || !victoryNameEl) return;

			victoryNameEl.textContent = winnerName;
			victoryOverlay.classList.add('show');
			
			// Start confetti animation
			startConfetti();
			
			// No auto-hide timeout - only close with 'j' key
			// Allow J key to close
			const closeHandler = (e) => {
				const key = (e.key || '').toLowerCase();
				if(key === 'j'){
					hideVictory();
					document.removeEventListener('keydown', closeHandler);
				}
			};
			document.addEventListener('keydown', closeHandler);
		}

		function hideVictory(){
			const victoryOverlay = document.getElementById('victoryOverlay');
			if(!victoryOverlay) return;
			victoryOverlay.classList.remove('show');
			stopConfetti();
		}

		// Confetti animation
		let confettiInterval = null;
		const confettiParticles = [];

		function startConfetti(){
			const canvas = document.getElementById('confettiCanvas');
			if(!canvas) return;
			const ctx = canvas.getContext('2d');
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;

			// Create confetti particles
			const colors = ['#f1c40f', '#ffeaa7', '#60a5fa', '#93c5fd', '#f87171', '#fbbf24', '#a78bfa'];
			confettiParticles.length = 0;
			for(let i = 0; i < 150; i++){
				confettiParticles.push({
					x: Math.random() * canvas.width,
					y: Math.random() * canvas.height - canvas.height,
					r: Math.random() * 6 + 4,
					d: Math.random() * 10 + 5,
					color: colors[Math.floor(Math.random() * colors.length)],
					tilt: Math.random() * 10 - 5,
					tiltAngle: 0,
					tiltAngleIncrement: Math.random() * 0.1 + 0.05
				});
			}

			// Animate confetti
			function drawConfetti(){
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				confettiParticles.forEach((p, i) => {
					ctx.beginPath();
					ctx.lineWidth = p.r / 2;
					ctx.strokeStyle = p.color;
					ctx.moveTo(p.x + p.tilt + p.r, p.y);
					ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r);
					ctx.stroke();

					// Update position
					p.tiltAngle += p.tiltAngleIncrement;
					p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
					p.x += Math.sin(p.d);
					p.tilt = Math.sin(p.tiltAngle) * 15;

					// Reset if out of bounds
					if(p.y > canvas.height){
						confettiParticles[i] = {
							x: Math.random() * canvas.width,
							y: -20,
							r: p.r,
							d: p.d,
							color: p.color,
							tilt: Math.random() * 10 - 5,
							tiltAngle: 0,
							tiltAngleIncrement: p.tiltAngleIncrement
						};
					}
				});
			}

			confettiInterval = setInterval(drawConfetti, 33);
		}

		function stopConfetti(){
			if(confettiInterval){
				clearInterval(confettiInterval);
				confettiInterval = null;
			}
			const canvas = document.getElementById('confettiCanvas');
			if(canvas){
				const ctx = canvas.getContext('2d');
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			confettiParticles.length = 0;
		}

		// Fullscreen toggle
			function toggleFullscreen(){
				if(!document.fullscreenElement){
					document.documentElement.requestFullscreen?.();
				} else {
					document.exitFullscreen?.();
				}
			}
			const fullscreenFloatBtn = document.getElementById('fullscreenFloatBtn');
			fullscreenFloatBtn.addEventListener('click', toggleFullscreen);
			document.addEventListener('fullscreenchange', ()=>{
				// Adjust opacity to indicate state
				if(document.fullscreenElement){
					fullscreenFloatBtn.style.opacity = '.9';
					fullscreenFloatBtn.textContent = '‚úï';
					fullscreenFloatBtn.title = 'Ukonƒçi≈• fullscreen';
				} else {
					fullscreenFloatBtn.style.opacity = '.35';
					fullscreenFloatBtn.textContent = '‚õ∂';
					fullscreenFloatBtn.title = 'Fullscreen';
				}
			});

		// Init
		renderGrid();
		renderTeachers();
		// Pokus o naƒç√≠tanie ≈°tudentov (ak s√∫bor e≈°te neexistuje, zobraz√≠ sa nen√°padn√° spr√°va v konzole)
		loadStudentsFromJson();
	})();
	</script>
</body>
</html>
